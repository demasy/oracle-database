#!/bin/bash
# Vulnerability Scanning Script for Oracle Database Project
# Author: Demasy <founder@demasy.io>
# Purpose: Automated security vulnerability scanning using Trivy

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCAN_DIR="./security-reports"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
SEVERITY_LEVELS="HIGH,CRITICAL"

# Images to scan
DB_IMAGE="container-registry.oracle.com/database/free:latest"
SERVER_IMAGE="oracle-database-demasylabs-oracle-server:latest"

# Create reports directory
mkdir -p "$SCAN_DIR"

echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}   Oracle Database Project - Vulnerability Scanning${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}\n"

# Check if Trivy is installed
if ! command -v trivy &> /dev/null; then
    echo -e "${RED}Error: Trivy is not installed${NC}"
    echo -e "${YELLOW}Install with: brew install trivy (macOS) or see https://aquasecurity.github.io/trivy/${NC}"
    exit 1
fi

echo -e "${GREEN}✓ Trivy found: $(trivy --version | head -1)${NC}\n"

# Function to scan an image
scan_image() {
    local image_name=$1
    local image_label=$2
    local report_prefix=$3
    
    echo -e "${BLUE}Scanning ${image_label}...${NC}"
    echo -e "Image: ${image_name}\n"
    
    # Terminal output scan
    echo -e "${YELLOW}Running scan with ${SEVERITY_LEVELS} severity levels...${NC}"
    trivy image --severity "$SEVERITY_LEVELS" "$image_name"
    
    # JSON report
    echo -e "\n${YELLOW}Generating JSON report...${NC}"
    trivy image --severity "$SEVERITY_LEVELS" \
        -f json \
        -o "${SCAN_DIR}/${report_prefix}_${TIMESTAMP}.json" \
        "$image_name"
    
    # HTML report
    echo -e "${YELLOW}Generating HTML report...${NC}"
    trivy image --severity "$SEVERITY_LEVELS" \
        -f template \
        --template "@contrib/html.tpl" \
        -o "${SCAN_DIR}/${report_prefix}_${TIMESTAMP}.html" \
        "$image_name"
    
    # SARIF report (for GitHub Security)
    echo -e "${YELLOW}Generating SARIF report...${NC}"
    trivy image --severity "$SEVERITY_LEVELS" \
        -f sarif \
        -o "${SCAN_DIR}/${report_prefix}_${TIMESTAMP}.sarif" \
        "$image_name"
    
    echo -e "${GREEN}✓ ${image_label} scan complete${NC}\n"
}

# Scan Oracle Database container
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}   Scanning Oracle Database Container${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}\n"
scan_image "$DB_IMAGE" "Oracle Database 26ai" "oracle-db-scan"

# Scan Demasy Server container
echo -e "\n${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}   Scanning Demasy Server Container${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}\n"
scan_image "$SERVER_IMAGE" "Demasy Server" "demasy-server-scan"

# Summary
echo -e "\n${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}   Scan Summary${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}\n"
echo -e "${GREEN}All scans completed successfully!${NC}"
echo -e "Reports saved to: ${YELLOW}${SCAN_DIR}/${NC}\n"

# List generated reports
echo -e "${BLUE}Generated Reports:${NC}"
ls -lh "${SCAN_DIR}"/*${TIMESTAMP}* 2>/dev/null || echo "No reports found"

echo -e "\n${YELLOW}Next Steps:${NC}"
echo -e "1. Review HTML reports: open ${SCAN_DIR}/*_${TIMESTAMP}.html"
echo -e "2. Review JSON reports for detailed CVE information"
echo -e "3. Update base images and dependencies to address vulnerabilities"
echo -e "4. For GitHub: Upload SARIF files to GitHub Security tab\n"

exit 0
