# ==============================================================================
# GitHub Actions Workflow: Build and Push Docker Image
# ==============================================================================
# Purpose: Automates building and publishing Oracle Database 23ai Docker image
#          to GitHub Container Registry (ghcr.io)
#
# Triggers:
#   - Push to main branch (builds and publishes with 'latest' tag)
#   - Version tags (v*.*.* pattern, e.g., v1.0.0, v2.1.3)
#   - Pull requests (builds only for validation, no publish)
#   - Manual dispatch via GitHub Actions UI
#
# Registry: GitHub Container Registry (ghcr.io/demasy/oracle-database)
# 
# Generated Image Tags:
#   For push to main:
#     - ghcr.io/demasy/oracle-database:latest
#     - ghcr.io/demasy/oracle-database:main
#     - ghcr.io/demasy/oracle-database:main-<commit-sha>
#   
#   For version tag (e.g., v1.2.3):
#     - ghcr.io/demasy/oracle-database:1.2.3
#     - ghcr.io/demasy/oracle-database:1.2
#     - ghcr.io/demasy/oracle-database:1
#
# Security:
#   - Uses GitHub's built-in GITHUB_TOKEN (no manual secrets needed)
#   - Minimal permissions (read contents, write packages)
#   - Pull requests cannot push images (build validation only)
#
# Performance:
#   - Uses Docker Buildx for optimized builds
#   - GitHub Actions cache enabled for faster subsequent builds
#   - Single platform (linux/amd64) for Oracle compatibility
#
# Author: Ahmed El-Demasy
# Repository: https://github.com/demasy/oracle-database
# ==============================================================================

name: Build and Push Docker Image

# Workflow triggers
on:
  push:
    branches: [ "main" ]          # Trigger on push to main branch
    tags:
      - 'v*.*.*'                  # Trigger on semantic version tags (v1.0.0, v2.1.3, etc.)
  pull_request:
    branches: [ "main" ]          # Trigger on PR to main (build only, no push)
  workflow_dispatch:              # Allow manual trigger from Actions UI

# Environment variables used across all jobs
env:
  REGISTRY: ghcr.io                    # GitHub Container Registry
  IMAGE_NAME: ${{ github.repository }} # Full repository name (owner/repo)

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    # Minimal required permissions for security
    permissions:
      contents: read    # Read repository contents
      packages: write   # Push to GitHub Container Registry

    steps:
      # Step 1: Checkout repository code
      # Fetches the repository files needed for Docker build
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Docker Buildx
      # Enables advanced Docker build features (caching, multi-platform support)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Authenticate to GitHub Container Registry
      # Only runs for push events (not for pull requests)
      # Uses built-in GITHUB_TOKEN for secure authentication
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}          # GitHub username that triggered workflow
          password: ${{ secrets.GITHUB_TOKEN }}  # Auto-generated token with package write permissions

      # Step 4: Generate Docker metadata (tags and labels)
      # Automatically creates appropriate tags based on trigger type
      # Examples:
      #   - main branch push â†’ latest, main, main-abc123
      #   - v1.2.3 tag â†’ 1.2.3, 1.2, 1
      #   - pull request â†’ pr-123
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch                          # Branch name (e.g., main)
            type=ref,event=pr                              # PR number (e.g., pr-123)
            type=semver,pattern={{version}}                # Full version (1.2.3)
            type=semver,pattern={{major}}.{{minor}}        # Major.minor (1.2)
            type=semver,pattern={{major}}                  # Major only (1)
            type=sha,prefix={{branch}}-                    # Branch + commit SHA (main-abc123)
            type=raw,value=latest,enable={{is_default_branch}}  # 'latest' tag for default branch only

      # Step 5: Build and push Docker image
      # Uses Buildx for optimized build with caching
      # Push only happens for non-PR events (push to main, tags, manual dispatch)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .                                       # Build context (current directory)
          file: ./Dockerfile                               # Path to Dockerfile
          push: ${{ github.event_name != 'pull_request' }} # Push to registry (except for PRs)
          tags: ${{ steps.meta.outputs.tags }}             # Tags generated in previous step
          labels: ${{ steps.meta.outputs.labels }}         # OCI labels (version, source, etc.)
          cache-from: type=gha                             # Use GitHub Actions cache for layers
          cache-to: type=gha,mode=max                      # Save all layers to cache
          platforms: linux/amd64                           # Oracle Database requires x86_64 architecture
          # Oracle software download URLs passed as build arguments
          build-args: |
            SRC_ORACLE_SQLCL=https://download.oracle.com/otn_software/java/sqldeveloper/sqlcl-latest.zip
            SRC_ORACLE_SQLPLUS=https://download.oracle.com/otn_software/linux/instantclient/instantclient-basiclite-linuxx64.zip
            SRC_ORACLE_APEX=https://download.oracle.com/otn_software/apex/apex-latest.zip
            SRC_ORACLE_ORDS=https://download.oracle.com/otn_software/java/ords/ords-latest.zip

      # Step 6: Display image digest (SHA256 hash)
      # Useful for verifying exact image version and security auditing
      - name: Image digest
        run: echo "Image digest::" ${{ steps.meta.outputs.digest }}

      # Step 7: Display all generated tags
      # Shows which tags were created and pushed to registry
      - name: Image tags
        run: echo "Image tags::" ${{ steps.meta.outputs.tags }}

      # Step 8: Security scan with Trivy
      # Scans the built image for vulnerabilities
      # Note: Oracle base images may contain known vulnerabilities
      # Exit code 0 to warn but not fail (adjust for production needs)
      - name: Run Trivy vulnerability scanner
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Warn only (change to '1' to fail on vulnerabilities)

      # Step 9: Upload security scan results to GitHub Security tab
      # Makes vulnerability reports visible in GitHub's Security dashboard
      - name: Upload Trivy scan results to GitHub Security tab
        if: always() && github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      # Step 10: Display image size
      # Helps track image bloat and optimization opportunities
      - name: Show image size
        if: github.event_name != 'pull_request'
        run: |
          docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"

      # Step 11: Test the built image
      # Basic smoke test to ensure the image starts correctly
      # Tests container can start and respond to basic commands
      - name: Test Docker image
        if: github.event_name != 'pull_request'
        run: |
          echo "ðŸ§ª Testing image basic functionality..."
          
          # Start container
          docker run --rm -d --name test-container \
            -e ORACLE_PWD=TestPassword123! \
            -e DATABASE_NAME=TESTDB \
            -e TZ=UTC \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          # Wait for container to be running
          timeout=30
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if docker ps --filter "name=test-container" --format "{{.Status}}" | grep -q "Up"; then
              echo "âœ… Container started successfully!"
              
              # Test basic commands
              echo "Testing Node.js server..."
              docker exec test-container node --version
              
              echo "Testing SQLcl availability..."
              docker exec test-container which sqlcl
              
              docker stop test-container
              echo "âœ… All tests passed!"
              exit 0
            fi
            echo "Waiting for container to start... ($elapsed/$timeout seconds)"
            sleep 3
            elapsed=$((elapsed + 3))
          done
          
          echo "âŒ Container failed to start"
          docker logs test-container || true
          docker stop test-container || true
          exit 1

      # Step 12: Create GitHub Release (only for version tags)
      # Automatically creates a release when a version tag is pushed
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## ðŸ³ Docker Image
            Pull this release:
            ```bash
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ```
            
            ## ðŸ“¦ Available Tags
            - `${{ github.ref_name }}` - This specific version
            - `latest` - Always points to the latest stable release
            
            ## ðŸ” Image Details
            - **Digest**: ${{ steps.meta.outputs.digest }}
            - **Registry**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
            - **Platform**: linux/amd64
            
            ## ðŸ“‹ What's Included
            - Oracle Database 23ai Free Edition
            - Oracle APEX 24.2.0
            - Oracle ORDS 25.3
            - Oracle SQLcl 25.3
            - Node.js 20.x Management Server
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 13: Post-build notifications (optional - requires setup)
      # Sends build status to Slack/Discord/Email
      # Uncomment and configure when notification integration is needed
      # - name: Notify build status
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: |
      #       Build ${{ job.status }}!
      #       Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
      #       Triggered by: ${{ github.actor }}
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      # Step 14: Generate SBOM (Software Bill of Materials)
      # Creates detailed inventory of all software components in the image
      # Critical for supply chain security and compliance
      - name: Generate SBOM with Syft
        if: github.event_name != 'pull_request'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: spdx-json
          output-file: sbom.spdx.json

      # Step 15: Upload SBOM as artifact
      # Makes SBOM available for download and auditing
      - name: Upload SBOM artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: sbom.spdx.json
          retention-days: 90

      # Step 16: Sign image with Cosign (optional - requires setup)
      # Provides cryptographic proof of image authenticity
      # Uncomment when you set up signing keys
      # - name: Install Cosign
      #   if: github.event_name != 'pull_request'
      #   uses: sigstore/cosign-installer@v3
      #
      # - name: Sign the published Docker image
      #   if: github.event_name != 'pull_request'
      #   env:
      #     COSIGN_EXPERIMENTAL: "true"
      #   run: |
      #     echo "${{ steps.meta.outputs.tags }}" | xargs -I {} cosign sign --yes {}@${{ steps.meta.outputs.digest }}

      # Step 17: Performance benchmarking
      # Tracks startup time and resource usage metrics
      - name: Benchmark container performance
        if: github.event_name != 'pull_request'
        run: |
          echo "ðŸ“Š Running performance benchmarks..."
          
          # Start container and measure startup time
          start_time=$(date +%s)
          docker run --rm -d --name bench-container \
            -e ORACLE_PWD=BenchPassword123! \
            -e DATABASE_NAME=BENCH \
            -e TZ=UTC \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          # Wait for container to be up
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if docker ps --filter "name=bench-container" --format "{{.Status}}" | grep -q "Up"; then
              end_time=$(date +%s)
              startup_time=$((end_time - start_time))
              
              # Get resource usage
              echo "ðŸ“ˆ Resource Usage:"
              docker stats bench-container --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
              
              echo "â±ï¸  Container startup time: ${startup_time} seconds"
              
              # Cleanup
              docker stop bench-container
              
              # Create performance report
              echo "## ðŸ“Š Performance Metrics" >> $GITHUB_STEP_SUMMARY
              echo "- **Container Startup**: ${startup_time}s" >> $GITHUB_STEP_SUMMARY
              echo "- **Build Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
              echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Platform**: linux/amd64" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
            sleep 3
            elapsed=$((elapsed + 3))
          done
          
          echo "âš ï¸ Benchmark timeout after ${timeout}s"
          docker stop bench-container || true
          exit 0  # Don't fail on benchmark timeout

      # Step 18: Update Docker Hub description (if using Docker Hub)
      # Keeps README.md synced with Docker Hub repository page
      # Uncomment if you also push to Docker Hub
      # - name: Update Docker Hub Description
      #   if: github.event_name != 'pull_request'
      #   uses: peter-evans/dockerhub-description@v3
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      #     repository: demasy/oracle-database
      #     readme-filepath: ./README.md

      # Step 19: Cleanup old packages
      # Prevents registry bloat by removing old/untagged images
      # Keeps only the last 5 versions of each major version
      - name: Cleanup old container images
        if: github.event_name != 'pull_request'
        continue-on-error: true  # Don't fail workflow if cleanup has issues
        uses: actions/delete-package-versions@v5
        with:
          package-name: oracle-database
          package-type: 'container'
          min-versions-to-keep: 5
          delete-only-untagged-versions: 'true'

      # Step 20: Build summary report
      # Creates comprehensive summary in GitHub Actions UI
      - name: Create build summary
        if: always()
        run: |
          echo "# ðŸš€ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ³ Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`${{ steps.meta.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull the image" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Run the container" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d --name oracle-db \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e ORACLE_PWD=YourPassword123 \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e DATABASE_NAME=MYDB \\" >> $GITHUB_STEP_SUMMARY
          echo "  -p 1521:1521 -p 8080:8080 \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
