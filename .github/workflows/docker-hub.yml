# ==============================================================================
# GitHub Actions Workflow: Build and Push to Docker Hub
# ==============================================================================
# Purpose: Automates building and publishing Oracle Database 23ai Docker image
#          to Docker Hub (hub.docker.com)
#
# Triggers:
#   - Push to main branch (builds and publishes with 'latest' tag)
#   - Version tags (v*.*.* pattern, e.g., v1.0.0, v2.1.3)
#   - Pull requests (builds only for validation, no publish)
#   - Manual dispatch via GitHub Actions UI
#
# Registry: Docker Hub (docker.io/demasy/oracle-database)
# 
# Generated Image Tags:
#   For push to main:
#     - demasy/oracle-database:latest
#     - demasy/oracle-database:main
#     - demasy/oracle-database:main-<commit-sha>
#   
#   For version tag (e.g., v1.2.3):
#     - demasy/oracle-database:1.2.3
#     - demasy/oracle-database:1.2
#     - demasy/oracle-database:1
#
# Prerequisites:
#   1. Create Docker Hub account at https://hub.docker.com
#   2. Create repository: demasy/oracle-database
#   3. Generate access token at https://hub.docker.com/settings/security
#   4. Add secrets to GitHub repository (Settings â†’ Secrets â†’ Actions):
#      - DOCKERHUB_USERNAME: Your Docker Hub username
#      - DOCKERHUB_TOKEN: Your Docker Hub access token
#
# Security:
#   - Uses Docker Hub access tokens (not passwords)
#   - Minimal permissions required
#   - Pull requests cannot push images (build validation only)
#
# Performance:
#   - Uses Docker Buildx for optimized builds
#   - GitHub Actions cache enabled for faster subsequent builds
#   - Single platform (linux/amd64) for Oracle compatibility
#
# Author: Ahmed El-Demasy
# Repository: https://github.com/demasy/oracle-database
# ==============================================================================

name: Build and Push to Docker Hub

# Workflow triggers
on:
  push:
    branches: [ "main" ]          # Trigger on push to main branch
    tags:
      - 'v*.*.*'                  # Trigger on semantic version tags (v1.0.0, v2.1.3, etc.)
  pull_request:
    branches: [ "main" ]          # Trigger on PR to main (build only, no push)
  workflow_dispatch:              # Allow manual trigger from Actions UI

# Environment variables used across all jobs
env:
  DOCKERHUB_USERNAME: demasy                    # Change to your Docker Hub username
  DOCKERHUB_REPOSITORY: demasy/oracle-database  # Change to your repository name

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository code
      # Fetches the repository files needed for Docker build
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Docker Buildx
      # Enables advanced Docker build features (caching, multi-platform support)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Authenticate to Docker Hub
      # Only runs for push events (not for pull requests)
      # Requires DOCKERHUB_USERNAME and DOCKERHUB_TOKEN secrets
      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # Docker Hub username from secrets
          password: ${{ secrets.DOCKERHUB_TOKEN }}     # Docker Hub access token from secrets

      # Step 4: Generate Docker metadata (tags and labels)
      # Automatically creates appropriate tags based on trigger type
      # Examples:
      #   - main branch push â†’ latest, main, main-abc123
      #   - v1.2.3 tag â†’ 1.2.3, 1.2, 1
      #   - pull request â†’ pr-123
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_REPOSITORY }}
          tags: |
            type=ref,event=branch                          # Branch name (e.g., main)
            type=ref,event=pr                              # PR number (e.g., pr-123)
            type=semver,pattern={{version}}                # Full version (1.2.3)
            type=semver,pattern={{major}}.{{minor}}        # Major.minor (1.2)
            type=semver,pattern={{major}}                  # Major only (1)
            type=sha,prefix={{branch}}-                    # Branch + commit SHA (main-abc123)
            type=raw,value=latest,enable={{is_default_branch}}  # 'latest' tag for default branch only

      # Step 5: Build and push Docker image
      # Uses Buildx for optimized build with caching
      # Push only happens for non-PR events (push to main, tags, manual dispatch)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .                                       # Build context (current directory)
          file: ./Dockerfile                               # Path to Dockerfile
          push: ${{ github.event_name != 'pull_request' }} # Push to registry (except for PRs)
          tags: ${{ steps.meta.outputs.tags }}             # Tags generated in previous step
          labels: ${{ steps.meta.outputs.labels }}         # OCI labels (version, source, etc.)
          cache-from: type=gha                             # Use GitHub Actions cache for layers
          cache-to: type=gha,mode=max                      # Save all layers to cache
          platforms: linux/amd64                           # Oracle Database requires x86_64 architecture
          # Oracle software download URLs passed as build arguments
          build-args: |
            SRC_ORACLE_SQLCL=https://download.oracle.com/otn_software/java/sqldeveloper/sqlcl-latest.zip
            SRC_ORACLE_SQLPLUS=https://download.oracle.com/otn_software/linux/instantclient/instantclient-basiclite-linuxx64.zip
            SRC_ORACLE_APEX=https://download.oracle.com/otn_software/apex/apex-latest.zip
            SRC_ORACLE_ORDS=https://download.oracle.com/otn_software/java/ords/ords-latest.zip

      # Step 6: Display image digest (SHA256 hash)
      # Useful for verifying exact image version and security auditing
      - name: Image digest
        run: echo "Image digest:: ${{ steps.meta.outputs.digest }}"

      # Step 7: Display all generated tags
      # Shows which tags were created and pushed to Docker Hub
      - name: Image tags
        run: echo "Image tags:: ${{ steps.meta.outputs.tags }}"

      # Step 8: Security scan with Trivy
      # Scans the built image for vulnerabilities
      # Note: Oracle base images may contain known vulnerabilities
      # Exit code 0 to warn but not fail (adjust for production needs)
      - name: Run Trivy vulnerability scanner
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKERHUB_REPOSITORY }}:latest
          format: 'table'
          output: 'trivy-results.txt'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Warn only (change to '1' to fail on vulnerabilities)

      # Step 9: Display image size
      # Helps track image bloat and optimization opportunities
      - name: Show image size
        if: github.event_name != 'pull_request'
        run: |
          docker images ${{ env.DOCKERHUB_REPOSITORY }} --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"

      # Step 10: Test the built image
      # Basic smoke test to ensure the image starts correctly
      - name: Test Docker image
        if: github.event_name != 'pull_request'
        run: |
          echo "ðŸ§ª Testing image basic functionality..."
          
          # Start container
          docker run --rm -d --name test-container \
            -e ORACLE_PWD=TestPassword123! \
            -e DATABASE_NAME=TESTDB \
            -e TZ=UTC \
            ${{ env.DOCKERHUB_REPOSITORY }}:latest
          
          # Wait for container to be running
          timeout=30
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if docker ps --filter "name=test-container" --format "{{.Status}}" | grep -q "Up"; then
              echo "âœ… Container started successfully!"
              
              # Test basic commands
              echo "Testing Node.js server..."
              docker exec test-container node --version
              
              echo "Testing SQLcl availability..."
              docker exec test-container which sqlcl
              
              docker stop test-container
              echo "âœ… All tests passed!"
              exit 0
            fi
            echo "Waiting for container to start... ($elapsed/$timeout seconds)"
            sleep 3
            elapsed=$((elapsed + 3))
          done
          
          echo "âŒ Container failed to start"
          docker logs test-container || true
          docker stop test-container || true
          exit 1

      # Step 11: Update Docker Hub repository description
      # Syncs README.md to Docker Hub repository page
      - name: Update Docker Hub Description
        if: github.event_name != 'pull_request'
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKERHUB_REPOSITORY }}
          readme-filepath: ./README.md
          short-description: "Complete containerized Oracle 23ai Free Edition with APEX & ORDS - Perfect for developers, DBAs, and learners!"

      # Step 12: Create GitHub Release (only for version tags)
      # Automatically creates a release when a version tag is pushed
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## ðŸ³ Docker Image on Docker Hub
            Pull this release from Docker Hub:
            ```bash
            docker pull ${{ env.DOCKERHUB_REPOSITORY }}:${{ github.ref_name }}
            ```
            
            ## ðŸ“¦ Available Tags
            - `${{ github.ref_name }}` - This specific version
            - `latest` - Always points to the latest stable release
            - `main` - Latest build from main branch
            
            ## ðŸ” Image Details
            - **Digest**: ${{ steps.meta.outputs.digest }}
            - **Registry**: Docker Hub (hub.docker.com)
            - **Repository**: ${{ env.DOCKERHUB_REPOSITORY }}
            - **Platform**: linux/amd64
            
            ## ðŸ“‹ What's Included
            - Oracle Database 23ai Free Edition
            - Oracle APEX 24.2.0
            - Oracle ORDS 25.3
            - Oracle SQLcl 25.3
            - Node.js 20.x Management Server
            
            ## ðŸš€ Quick Start
            ```bash
            docker run -d --name oracle-db \
              -e ORACLE_PWD=YourPassword123 \
              -e DATABASE_NAME=MYDB \
              -p 1521:1521 -p 8080:8080 \
              ${{ env.DOCKERHUB_REPOSITORY }}:${{ github.ref_name }}
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 13: Build summary report
      # Creates comprehensive summary in GitHub Actions UI
      - name: Create build summary
        if: always()
        run: |
          echo "# ðŸ³ Docker Hub Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ³ Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: Docker Hub (hub.docker.com)" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: \`${{ env.DOCKERHUB_REPOSITORY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`${{ steps.meta.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull the image from Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKERHUB_REPOSITORY }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Run the container" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d --name oracle-db \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e ORACLE_PWD=YourPassword123 \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e DATABASE_NAME=MYDB \\" >> $GITHUB_STEP_SUMMARY
          echo "  -p 1521:1521 -p 5500:5500 -p 8080:8080 \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.DOCKERHUB_REPOSITORY }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub Repository](https://hub.docker.com/r/${{ env.DOCKERHUB_REPOSITORY }})" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
